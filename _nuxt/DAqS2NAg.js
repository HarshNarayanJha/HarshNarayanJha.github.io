const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CPIdRFgf.js","./DqoQsg5Q.js"])))=>i.map(i=>d[i]);
import{_ as l}from"./DqoQsg5Q.js";import{c as d,a as w,t as u}from"./Th0oA6Z_.js";import"./DlAUqK2U.js";async function p(t,e){return await $fetch(`/api/content/${e}/database.sql`,{context:{},responseType:"text",headers:{"content-type":"text/plain"},query:{v:d[String(e)],t:void 0}})}async function h(t,e="gzip"){var s;const r=Uint8Array.from(atob(t),c=>c.charCodeAt(0)),n=(s=new Response(new Blob([r])).body)==null?void 0:s.pipeThrough(new DecompressionStream(e));return(await new Response(n).text()).split(`
`)}function m(t,e){const r=g(t),o={...e};for(const n in o)r[n]==="json"&&o[n]&&o[n]!=="undefined"&&(o[n]=JSON.parse(o[n])),r[n]==="boolean"&&o[n]!=="undefined"&&(o[n]=!!o[n]);for(const n in o)o[n]==="NULL"&&(o[n]=void 0);return o}function g(t){const e=t.match(/FROM\s+(\w+)/);if(!e)return{};const r=w[S(e[1])];return(r==null?void 0:r.fields)||{}}function S(t){return t.replace(/^_content_/,"")}let a;function _(t){return{all:async(e,r)=>(await f(t),a.exec({sql:e,bind:r,rowMode:"object",returnValue:"resultRows"}).map(o=>m(e,o))),first:async(e,r)=>(await f(t),m(e,a.exec({sql:e,bind:r,rowMode:"object",returnValue:"resultRows"}).shift())),exec:async e=>{await f(t),await a.exec({sql:e})}}}async function f(t){if(!a){const s=await(await l(()=>import("./CPIdRFgf.js"),__vite__mapDeps([0,1]),import.meta.url).then(c=>c.default))();a=new s.oo1.DB}if(window.sessionStorage.getItem("previewToken"))return a;let e=null;const r=`checksum_${t}`,o=`collection_${t}`;let n="matched";try{const i=a.exec({sql:`SELECT * FROM ${u.info} where id = '${r}'`,rowMode:"object",returnValue:"resultRows"}).shift();(i==null?void 0:i.version)!==d[String(t)]&&(n="mismatch")}catch{n="missing"}if(n!=="matched"){if(window.localStorage.getItem(`content_${r}`)===d[String(t)]&&(e=window.localStorage.getItem(`content_${o}`)),!e){e=await p(void 0,String(t));try{window.localStorage.setItem(`content_${r}`,d[String(t)]),window.localStorage.setItem(`content_${o}`,e)}catch(s){console.error("Database integrity check failed, rebuilding database",s)}}const i=await h(e);await a.exec({sql:`DROP TABLE IF EXISTS ${u[String(t)]}`}),n==="mismatch"&&await a.exec({sql:`DELETE FROM ${u.info} WHERE id = '${r}'`});for(const s of i)try{await a.exec(s)}catch(c){console.error("Error executing command",c)}}return a}export{_ as loadDatabaseAdapter};
